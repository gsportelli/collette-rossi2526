<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- scoraggia l'indicizzazione -->
  <meta name="robots" content="noindex, nofollow, noimageindex, noarchive">
  <meta name="googlebot" content="noindex, nofollow, noimageindex, noarchive">
  <link rel="icon" href="./favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
  <link rel="apple-touch-icon" href="./apple-touch-icon.png">
  <link rel="manifest" href="./site.webmanifest">
  <meta name="theme-color" content="#ffffff">
  <title>Collette</title>
  <style>
    :root { --maxw: 900px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
           margin: 2rem auto; max-width: var(--maxw); padding: 0 1rem; }
    h1 { margin: 0 0 .75rem 0; }
    section { margin: 1.5rem 0 2rem; }
    h2 { margin: 0 0 .5rem 0; }
    .grid { display:grid; grid-template-columns: 1fr auto; gap:.2rem .75rem; align-items:center; }
    .name { padding:.25rem 0; }
    .status { justify-self:end; font-variant-numeric: tabular-nums; }
    .paid { font-weight:600; }
    .out  { opacity:.8; font-style: italic; }
    .pending { opacity:.95; }
    .empty { margin: 2rem 0; font-size: 1.05rem; color: #444; }
    footer { margin-top:2rem; font-size:.9rem; color:#666; }
  </style>
</head>
<body>
  <h1>Collette</h1>
  <div id="container"></div>
  <footer id="updated"></footer>

  <script>
    // formattazione € stile it-IT: "12,00€"
    const EURO = n => (n ?? 0).toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + '€';
    // stessa funzione di slug usata nell'admin
    const slug = s => s.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase()
                     .replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");

    fetch('./data/state.json?cb=' + Date.now())
      .then(r => r.json())
      .then(state => {
        const wrap   = document.getElementById('container');
        const footer = document.getElementById('updated');

        const roster = (state.roster || []).slice().sort((a,b)=>a.localeCompare(b));
        const colsAll = (state.collections || []);
        const cols    = colsAll.filter(c => !c.archived);  // ← nasconde le archiviate
        
        // nessuna colletta → mostra solo il messaggio semplice
        if (!cols.length) {
          wrap.innerHTML = '<p class="empty">Non ci sono collette attive</p>';
          if (footer) footer.textContent = ''; // niente "ultimo aggiornamento"
          return;
        }

        // ci sono collette → renderizza ogni sezione
        cols.forEach(coll => {
          const sec  = document.createElement('section');
          const h2   = document.createElement('h2'); h2.textContent = coll.title || coll.id || 'Colletta';
          const grid = document.createElement('div'); grid.className = 'grid';

          roster.forEach(name => {
            const id = slug(name);
            const st = coll.statuses && coll.statuses[id];

            let label = 'non pagato', cls = 'pending';
            if (st && st.type === 'out') { label = 'non partecipa'; cls = 'out'; }
            else if (st && (st.type === 'paid' || st.type === 'partial')) {
              label = EURO(st.amount || 0); cls = 'paid';
            }

            const nameEl   = document.createElement('div'); nameEl.className = 'name';   nameEl.textContent = name;
            const statusEl = document.createElement('div'); statusEl.className = 'status ' + cls; statusEl.textContent = label;

            grid.appendChild(nameEl);
            grid.appendChild(statusEl);
          });

          sec.appendChild(h2);
          sec.appendChild(grid);
          wrap.appendChild(sec);
        });

        if (footer) {
          const ts = state.updated ? new Date(state.updated) : null;
          footer.textContent = ts ? ('Ultimo aggiornamento: ' + ts.toLocaleString()) : '';
        }
      })
      .catch(() => {
        // fallback molto semplice in caso di errore di fetch
        const wrap = document.getElementById('container');
        wrap.innerHTML = '<p class="empty">Non ci sono collette attive</p>';
        const footer = document.getElementById('updated');
        if (footer) footer.textContent = '';
      });
  </script>
</body>
</html>
