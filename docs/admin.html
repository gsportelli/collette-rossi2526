<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex, nofollow, noimageindex, noarchive">
<meta name="googlebot" content="noindex, nofollow, noimageindex, noarchive">
<link rel="icon" href="./favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
<link rel="apple-touch-icon" href="./apple-touch-icon.png">
<link rel="manifest" href="./admin.webmanifest">
<meta name="theme-color" content="#ffffff">
<title>Collette ‚Äì Admin</title>

<!-- Bootstrap + Bootswatch Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.2/flatly/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body {
  padding-bottom: 3rem;
}
.toast-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 9999;
}
.sticky-save-bar {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  padding: 0.75rem 0;
  margin-bottom: 1rem;
}
.sticky-save-bar .btn {
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.section-header {
  cursor: pointer;
  user-select: none;
  transition: background-color 0.2s;
  border-radius: 0.375rem;
  padding: 0.5rem;
  margin: -0.5rem;
}
.section-header:hover {
  background-color: rgba(0,0,0,0.03);
}
.section-header i.fa-chevron-down {
  transition: transform 0.3s;
}
.collapsed-section .section-header i.fa-chevron-down {
  transform: rotate(-90deg);
}
.status-badge {
  font-size: 0.8rem;
  padding: 0.25rem 0.6rem;
}
.grid-header {
  display: grid;
  grid-template-columns: 1fr auto; /* nome | stato */
  gap: 0.5rem;
  align-items: center;
  padding: 0.75rem;
  background-color: rgba(0,0,0,0.03);
  border-radius: 0.375rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
  padding-left: 0.75rem;
  padding-right: 0.75rem;
}

}
.grid-row {
  display: grid;
  grid-template-columns: minmax(0,1fr) auto;
  padding: 0.5rem 0.5rem;
  gap: 0.5rem;
  align-items: center;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}
.grid-row:last-child {
  border-bottom: none;
}
.grid-row:hover {
  background-color: rgba(0,0,0,0.02);
}
.person-name {
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.status-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  min-width: 80px;
}
.status-switch {
  display: inline-flex;
  background: #e9ecef;
  border-radius: 20px;
  padding: 2px;
  gap: 2px;
  white-space: nowrap;
}
.status-switch input[type="radio"] {
  display: none;
}
.status-switch label {
  padding: 0.35rem 0.55rem;
  border-radius: 17px;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  color: #6c757d;
  font-weight: 500;
  white-space: nowrap;
  user-select: none;
}
.status-switch input[type="radio"]:checked + label {
  background: white;
  color: #212529;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.status-switch label:hover {
  color: #212529;
}

.status-switch input[type="radio"]:checked + label {
  background: white;
  color: #212529;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.status-switch input[type="radio"]:checked + label.status-switch-unpaid {
  background: #fa8072; /* salmon */
  color: white;
}

.status-switch input[type="radio"]:checked + label.status-switch-out {
  background: #ffb347; /* amber soft */
  color: #212529;
}

.status-switch input[type="radio"]:checked + label.status-switch-paid {
  background: #18bc9c; /* flatly emerald/teal */
  color: white;
}

#collectionsCard .card-body {
  padding-left: 0.75rem;
  padding-right: 0.75rem;
}

.amount-input-group {
  display: flex;
  gap: 0.25rem;
  align-items: center;
  justify-content: flex-end;
}
.amount-input-group input[type="radio"] {
  flex-shrink: 0;
}
.amount-input-group input[type="number"] {
  width: 80px;
  flex-shrink: 0;
}
.amount-input-group .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  flex-shrink: 0;
}
@media (max-width: 768px) {

  .container {
    padding-left: 8px;
    padding-right: 8px;
  }
  #collectionsCard .card-body {
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
  .grid-header {
    grid-template-columns: 1fr;
    text-align: center;
    padding-left: 0.5rem;
    padding-right: 0.5rem;
  }
  .grid-header > span:not(:first-child) {
    display: none;
  }
  .grid-row {
    grid-template-columns: 1fr;
    gap: 0.75rem;
    padding-left: 0.4rem;
    padding-right: 0.4rem;
  }
  .person-name {
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .status-switch {
    width: 100%;
    justify-content: center;
    padding: 1px;
    gap: 1px;
  }
  .status-switch label {
    padding: 0.3rem 0.45rem;
    font-size: 0.75rem;
  }
  .amount-input-group {
    justify-content: center;
  }
  .amount-input-group input {
    flex: 1;
  }
}
.fade-in {
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container"></div>

<!-- Sticky Save Bar -->
<div class="sticky-save-bar" id="savebar" style="display:none;">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div class="text-white">
        <i class="fas fa-save me-2"></i>
        <span id="currentCollectionName" class="fw-bold">Colletta</span>
      </div>
      <div class="d-flex gap-2">
        <a class="btn btn-light btn-sm" href="index.html">
          <i class="fas fa-list-check me-1"></i>Lista pubblica
        </a>
        <button class="btn btn-light btn-sm" id="stickyLoad">
          <i class="fas fa-download me-1"></i>Ricarica
        </button>
        <button class="btn btn-success btn-sm" id="stickySave">
          <i class="fas fa-save me-1"></i>Salva modifiche
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
      <i class="fas fa-hand-holding-usd text-primary me-2"></i>
      Collette ‚Äì Admin
    </h1>
  </div>

  <!-- Section 1: Config -->
  <div class="card mb-3 shadow-sm" id="cfgCard">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <div>
        <h5 class="mb-1">
          <i class="fas fa-cog text-primary me-2"></i>
          1) Configurazione
        </h5>
        <span class="status-badge badge bg-secondary" id="cfgStatus">Nessun token</span>
      </div>
      <button id="cfgOpenBtn" class="btn btn-primary align-self-start" data-bs-toggle="modal" data-bs-target="#cfgModal">
        <i class="fas fa-sliders-h me-1"></i>Apri configurazione
      </button>
    </div>
  </div>

  <!-- Section 2: State and Roster -->
  <div class="card mb-3 shadow-sm" id="stateCard">
    <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
      <div>
        <h5 class="mb-1">
          <i class="fas fa-users text-success me-2"></i>
          2) Stato e Roster
        </h5>
        <span class="status-badge badge bg-info" id="stateStatus">Non caricato</span>
      </div>
      <button id="stateOpenBtn" class="btn btn-outline-primary align-self-start" data-bs-toggle="modal" data-bs-target="#stateModal">
        <i class="fas fa-database me-1"></i>Gestisci stato
      </button>
    </div>
  </div>

  <!-- Section 3: Collections -->
  <div class="card mb-3 shadow-sm" id="collectionsCard" hidden>
    <div class="card-body">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-3">
        <h5 class="mb-0">
          <i class="fas fa-folder-open text-warning me-2"></i>
          3) Collette
        </h5>
        <button id="collConfigBtn" class="btn btn-outline-secondary align-self-start" data-bs-toggle="modal" data-bs-target="#collConfigModal">
          <i class="fas fa-pen-to-square me-1"></i>Configura colletta
        </button>
      </div>

      <div class="grid-header">
        <span><i class="fas fa-user me-1"></i>Nome</span>
        <span class="text-center">Stato</span>
      </div>
      <div id="grid"></div>
    </div>
  </div>
</div>

<!-- Config Modal -->
<div class="modal fade" id="cfgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Configurazione</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Owner</label>
            <input id="owner" type="text" class="form-control" placeholder="tuo-username">
          </div>
          <div class="col-md-6">
            <label class="form-label">Repo</label>
            <input id="repo" type="text" class="form-control" placeholder="collette-rossi2526" value="collette-rossi2526">
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">GitHub Fine-grained Token</label>
          <input id="token" type="password" class="form-control" placeholder="ghp_...">
          <small class="form-text text-muted">Il token resta solo in questo browser (localStorage).</small>
        </div>
      </div>
      <div class="modal-footer">
        <button id="clearCfg" class="btn btn-outline-secondary">
          <i class="fas fa-trash me-1"></i>Pulisci config
        </button>
        <button id="saveCfg" class="btn btn-primary">
          <i class="fas fa-save me-1"></i>Salva su questo dispositivo
        </button>
      </div>
    </div>
  </div>
</div>

<!-- State Modal -->
<div class="modal fade" id="stateModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="fas fa-users me-2"></i>Stato e Roster</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex flex-wrap gap-2 mb-3">
          <button id="load" class="btn btn-outline-primary">
            <i class="fas fa-download me-1"></i>Carica stato
          </button>
          <button id="save" class="btn btn-success">
            <i class="fas fa-save me-1"></i>Salva modifiche
          </button>
        </div>
        <div class="alert alert-info mb-3">
          <i class="fas fa-info-circle me-2"></i>
          <small>File: <code>docs/data/state.json</code></small>
        </div>
        <div>
          <label class="form-label">
            <i class="fas fa-list me-1"></i>Roster (un nome per riga ‚Äì usa "Nome + iniziale cognome")
          </label>
          <textarea id="roster" class="form-control" rows="8"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Collection Config Modal -->
<div class="modal fade" id="collConfigModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title"><i class="fas fa-folder-open me-2"></i>Configura colletta</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Seleziona colletta</label>
          <select id="selColl" class="form-select">
            <option value="__new__">+ Nuova colletta</option>
          </select>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-5">
            <label class="form-label">Titolo</label>
            <input id="collTitle" type="text" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">ID</label>
            <input id="collId" type="text" class="form-control" placeholder="es: regalo-natale-2025">
          </div>
          <div class="col-md-2">
            <label class="form-label">Quota attesa (‚Ç¨)</label>
            <input id="collDue" type="number" step="1" min="0" class="form-control">
          </div>
          <div class="col-md-1">
            <label class="form-label">Archiviata</label>
            <div class="form-check form-switch mt-2">
              <input id="collArchived" type="checkbox" class="form-check-input" role="switch" style="width: 3rem; height: 1.5rem;">
            </div>
          </div>
        </div>
        <small class="text-muted d-block">ID stabile (niente spazi), usato come chiave.</small>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-check me-1"></i>Chiudi
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
// --- UTF-8 safe base64 (Unicode-friendly) ---
function b64encodeUtf8(str) {
  if (window.TextEncoder) {
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
  }
  return btoa(unescape(encodeURIComponent(str)));
}
function b64decodeUtf8(b64) {
  const bin = atob(b64);
  if (window.TextDecoder) {
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
  }
  return decodeURIComponent(escape(bin));
}

const EURO = n => (n ?? 0).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2})+'‚Ç¨';
const stripDiacritics = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
const _supportsUnicodeProps = (() => { try { new RegExp('\\p{L}', 'u'); return true; } catch { return false; } })();
const slug = (s) => {
  const noMarks = stripDiacritics(String(s));
  const re = _supportsUnicodeProps ? /[^\p{Letter}\p{Number}]+/gu : /[^a-z0-9]+/g;
  return noMarks.toLowerCase().replace(re, '-').replace(/(^-|-$)/g, '');
};
const byId = id => document.getElementById(id);

function showToast(message, type = 'success') {
  const container = document.querySelector('.toast-container');
  const toastId = 'toast-' + Date.now();
  
  const icons = {
    success: 'fa-check-circle',
    error: 'fa-exclamation-circle',
    warning: 'fa-exclamation-triangle',
    info: 'fa-info-circle'
  };
  
  const bgColors = {
    success: 'bg-success',
    error: 'bg-danger',
    warning: 'bg-warning',
    info: 'bg-info'
  };
  
  const toastHTML = `
    <div id="${toastId}" class="toast align-items-center text-white ${bgColors[type]} border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          <i class="fas ${icons[type]} me-2"></i>${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', toastHTML);
  const toastElement = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastElement, { delay: type === 'error' ? 5000 : 3000 });
  toast.show();
  
  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}

function confirmAction(message) {
  return confirmActionHTML(message, null);
}

function confirmActionHTML(title, bodyHTML) {
  return new Promise((resolve) => {
    const modalId = 'confirmModal-' + Date.now();
    
    // If message contains HTML tags, treat first param as body
    const isSimple = !bodyHTML && !title.includes('<');
    const actualTitle = isSimple ? 'Conferma azione' : title;
    const actualBody = isSimple ? title : (bodyHTML || '');
    
    const modalHTML = `
      <div class="modal fade" id="${modalId}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered ${actualBody ? 'modal-lg' : ''}">
          <div class="modal-content">
            <div class="modal-header bg-warning">
              <h5 class="modal-title"><i class="fas fa-question-circle me-2"></i>${actualTitle}</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">${actualBody || title}</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Annulla
              </button>
              <button type="button" class="btn btn-warning" id="${modalId}-confirm">
                <i class="fas fa-check me-1"></i>Conferma
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modalElement = document.getElementById(modalId);
    const modal = new bootstrap.Modal(modalElement);
    
    document.getElementById(modalId + '-confirm').addEventListener('click', () => {
      modal.hide();
      resolve(true);
    });
    
    modalElement.addEventListener('hidden.bs.modal', () => {
      if (!modalElement.dataset.confirmed) {
        resolve(false);
      }
      modalElement.remove();
    });
    
    modalElement.addEventListener('click', (e) => {
      if (e.target.id === modalId + '-confirm') {
        modalElement.dataset.confirmed = 'true';
      }
    });
    
    modal.show();
  });
}

function promptInput(message, defaultValue = '', placeholder = '') {
  return new Promise((resolve) => {
    const modalId = 'promptModal-' + Date.now();
    const modalHTML = `
      <div class="modal fade" id="${modalId}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Input richiesto</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <label class="form-label fw-bold">${message}</label>
              <input type="text" class="form-control form-control-lg" id="${modalId}-input" value="${defaultValue}" placeholder="${placeholder}">
              ${placeholder ? '<small class="form-text text-muted mt-2 d-block">' + placeholder + '</small>' : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                <i class="fas fa-times me-1"></i>Annulla
              </button>
              <button type="button" class="btn btn-primary" id="${modalId}-confirm">
                <i class="fas fa-check me-1"></i>OK
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    const modalElement = document.getElementById(modalId);
    const inputElement = document.getElementById(modalId + '-input');
    const modal = new bootstrap.Modal(modalElement);
    
    document.getElementById(modalId + '-confirm').addEventListener('click', () => {
      modalElement.dataset.value = inputElement.value;
      modal.hide();
    });
    
    inputElement.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        modalElement.dataset.value = inputElement.value;
        modal.hide();
      }
    });
    
    modalElement.addEventListener('shown.bs.modal', () => {
      inputElement.focus();
      inputElement.select();
    });
    
    modalElement.addEventListener('hidden.bs.modal', () => {
      const value = modalElement.dataset.value;
      modalElement.remove();
      resolve(value || null);
    });
    
    modal.show();
  });
}


function storageUsable() {
  try {
    const k = '__probe__' + Math.random().toString(36).slice(2);
    localStorage.setItem(k, '1'); localStorage.removeItem(k);
    return true;
  } catch (_) { return false; }
}

const SafeStore = (() => {
  const ok = typeof window !== 'undefined' && 'localStorage' in window && storageUsable();
  const mem = {};
  return {
    ok,
    getItem: k => { try { return ok ? localStorage.getItem(k) : (k in mem ? mem[k] : null); } catch (_) { return k in mem ? mem[k] : null; } },
    setItem: (k, v) => { const s = (v ?? '').toString(); try { ok ? localStorage.setItem(k, s) : (mem[k] = s); } catch (_) { mem[k] = s; } },
    removeItem: k => { try { ok ? localStorage.removeItem(k) : delete mem[k]; } catch (_) { delete mem[k]; } },
  };
})();

const val = id => (byId(id)?.value ?? '').toString();
const DEFAULT_REPO = 'collette-rossi2526';
const DEFAULT_OWNER = 'gsportelli';

const LS = {
  get(){ 
    return {
      owner: SafeStore.getItem('col_owner') || '',
      repo:  SafeStore.getItem('col_repo')  || DEFAULT_REPO,
      token: SafeStore.getItem('col_token') || '',
    };
  },
  set(o = {}){
    if ('owner' in o) SafeStore.setItem('col_owner', (o.owner ?? '').toString().trim());
    if ('repo'  in o) {
      let r = (o.repo ?? DEFAULT_REPO).toString().trim();
      if (!r) r = DEFAULT_REPO;
      SafeStore.setItem('col_repo', r);
    }
    if ('token' in o) SafeStore.setItem('col_token', (o.token ?? '').toString().trim());
  },
  clear(){ ['col_owner','col_repo','col_token'].forEach(k => SafeStore.removeItem(k)); }
};

let SHA = null;
let DB = null;
let CURRENT = null;
let ORIGINAL_STATE = null; // Snapshot dello stato originale per tracking modifiche

function captureOriginalState() {
  ORIGINAL_STATE = JSON.parse(JSON.stringify(DB));
}

function getChanges() {
  if (!ORIGINAL_STATE || !DB) return null;
  
  const changes = {
    roster: { added: [], removed: [] },
    collections: { added: [], modified: [], archived: [], unarchived: [] },
    payments: { added: [], modified: [], removed: [], downgrades: [] }
  };
  
  // Check roster changes
  const origRoster = new Set(ORIGINAL_STATE.roster || []);
  const currRoster = new Set(DB.roster || []);
  
  currRoster.forEach(name => {
    if (!origRoster.has(name)) changes.roster.added.push(name);
  });
  origRoster.forEach(name => {
    if (!currRoster.has(name)) changes.roster.removed.push(name);
  });
  
  // Check collections changes
  const origCollIds = new Set((ORIGINAL_STATE.collections || []).map(c => c.id));
  const currCollIds = new Set((DB.collections || []).map(c => c.id));
  
  DB.collections?.forEach(coll => {
    if (!origCollIds.has(coll.id)) {
      changes.collections.added.push(coll.title || coll.id);
    } else {
      const orig = ORIGINAL_STATE.collections.find(c => c.id === coll.id);
      if (orig) {
        if (orig.title !== coll.title || orig.amount_due !== coll.amount_due) {
          changes.collections.modified.push({
            name: coll.title || coll.id,
            changes: []
          });
          if (orig.title !== coll.title) {
            changes.collections.modified[changes.collections.modified.length-1].changes.push(
              `titolo: "${orig.title}" ‚Üí "${coll.title}"`
            );
          }
          if (orig.amount_due !== coll.amount_due) {
            changes.collections.modified[changes.collections.modified.length-1].changes.push(
              `quota: ${orig.amount_due}‚Ç¨ ‚Üí ${coll.amount_due}‚Ç¨`
            );
          }
        }
        if (!orig.archived && coll.archived) {
          changes.collections.archived.push(coll.title || coll.id);
        }
        if (orig.archived && !coll.archived) {
          changes.collections.unarchived.push(coll.title || coll.id);
        }
      }
    }
  });
  
  // Check payment status changes for current collection
  if (CURRENT) {
    const origColl = ORIGINAL_STATE.collections?.find(c => c.id === CURRENT.id);
    if (origColl) {
      const origStatuses = origColl.statuses || {};
      const currStatuses = CURRENT.statuses || {};
      
      DB.roster?.forEach(name => {
        const id = slug(name);
        const origSt = origStatuses[id];
        const currSt = currStatuses[id];
        
        const origType = origSt?.type || 'unpaid';
        const currType = currSt?.type || 'unpaid';
        const origAmount = origSt?.amount || 0;
        const currAmount = currSt?.amount || 0;
        
        if (origType !== currType || origAmount !== currAmount) {
          const change = {
            name,
            from: formatStatus(origType, origAmount),
            to: formatStatus(currType, currAmount)
          };
          
          // Check for downgrades (paid -> unpaid/out)
          if (origType === 'paid' && (currType === 'unpaid' || currType === 'out')) {
            changes.payments.downgrades.push(change);
          } else if (origType === 'unpaid' && currType !== 'unpaid') {
            changes.payments.added.push(change);
          } else if (currType === 'unpaid' && origType !== 'unpaid') {
            changes.payments.removed.push(change);
          } else {
            changes.payments.modified.push(change);
          }
        }
      });
    }
  }
  
  return changes;
}

function formatStatus(type, amount) {
  if (type === 'out') return 'Non partecipa';
  if (type === 'unpaid' || !type) return 'Non pagato';
  if (type === 'paid') return `Versato ${amount}‚Ç¨`;
  return type;
}

function cloneStatus(st) {
  if (!st) return { type: 'unpaid', amount: 0 };
  return JSON.parse(JSON.stringify(st));
}

function normalizeStatusForDisplay(st, _due) {
  // Normalizziamo lo stato visibile con le sole opzioni supportate
  if (!st || st.type === 'unpaid') return { type: 'unpaid', amount: 0 };
  if (st.type === 'out') return { type: 'out' };
  const amt = Number(st.amount || 0);
  return { type: 'paid', amount: amt };
}

function isDowngrade(prev, next) {
  // Downgrade se si passa da paid ‚Üí unpaid | out | paid con importo diverso
  const wasPaid = prev && prev.type === 'paid';
  if (!wasPaid) return false;
  if (!next || next.type === 'unpaid' || next.type === 'out') return true;
  if (next.type === 'paid') {
    const a = Number(prev.amount || 0), b = Number(next.amount || 0);
    return a !== b;
  }
  return false;
}

/** Modale con due bottoni: "Torna allo stato precedente" e "Conferma modifica" */
function confirmPaymentChange(prevLabel, nextLabel) {
  return new Promise((resolve) => {
    const modalId = 'payChange-' + Date.now();
    const html = `
      <div class="modal fade" id="${modalId}" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header bg-warning">
              <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Possibile errore di modifica</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <p>Stai modificando uno stato <strong>gi√† pagato</strong>:</p>
              <ul class="mb-3">
                <li><strong>Da:</strong> ${prevLabel}</li>
                <li><strong>A:</strong> ${nextLabel}</li>
              </ul>
              <p>Vuoi davvero procedere? In caso di click errato puoi tornare allo stato precedente.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" id="${modalId}-revert">
                <i class="fas fa-undo me-1"></i>Torna allo stato precedente
              </button>
              <button type="button" class="btn btn-warning" id="${modalId}-confirm">
                <i class="fas fa-check me-1"></i>Conferma modifica
              </button>
            </div>
          </div>
        </div>
      </div>`;
    document.body.insertAdjacentHTML('beforeend', html);
    const el = document.getElementById(modalId);
    const modal = new bootstrap.Modal(el);

    el.querySelector('#'+modalId+'-revert').addEventListener('click', () => {
      modal.hide(); resolve('revert');
    });
    el.querySelector('#'+modalId+'-confirm').addEventListener('click', () => {
      modal.hide(); resolve('confirm');
    });
    // Restore on ESC or any other way the modal is closed
    el.addEventListener('hidden.bs.modal', () => {
      // If neither button was pressed, treat as revert
      if (!el.dataset.choice) {
        resolve('revert');
      }
      el.remove();
    });
    // Mark which button was pressed
    el.querySelector('#'+modalId+'-revert').addEventListener('click', () => {
      el.dataset.choice = 'revert';
    });
    el.querySelector('#'+modalId+'-confirm').addEventListener('click', () => {
      el.dataset.choice = 'confirm';
    });
    modal.show();
  });
}

function formatChangesHTML(changes) {
  if (!changes) return '<p class="text-muted">Nessuna modifica</p>';
  
  let html = '';
  let hasChanges = false;
  
  if (changes.roster.added.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-user-plus text-success me-2"></i>Persone aggiunte al roster:</strong><ul class="mb-0">';
    changes.roster.added.forEach(n => html += `<li>${n}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.roster.removed.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-user-minus text-danger me-2"></i>Persone rimosse dal roster:</strong><ul class="mb-0">';
    changes.roster.removed.forEach(n => html += `<li>${n}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.collections.added.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-plus-circle text-success me-2"></i>Collette create:</strong><ul class="mb-0">';
    changes.collections.added.forEach(n => html += `<li>${n}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.collections.modified.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-edit text-info me-2"></i>Collette modificate:</strong><ul class="mb-0">';
    changes.collections.modified.forEach(m => {
      html += `<li>${m.name}: ${m.changes.join(', ')}</li>`;
    });
    html += '</ul></div>';
  }
  
  if (changes.collections.archived.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-archive text-warning me-2"></i>Collette archiviate:</strong><ul class="mb-0">';
    changes.collections.archived.forEach(n => html += `<li>${n}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.collections.unarchived.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-box-open text-info me-2"></i>Collette riattivate:</strong><ul class="mb-0">';
    changes.collections.unarchived.forEach(n => html += `<li>${n}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.payments.downgrades.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-exclamation-triangle text-danger me-2"></i>Attenzione - Stato pagamento diminuito:</strong><ul class="mb-0 text-danger">';
    changes.payments.downgrades.forEach(p => html += `<li><strong>${p.name}</strong>: ${p.from} ‚Üí ${p.to}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.payments.added.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-money-bill-wave text-success me-2"></i>Pagamenti aggiunti:</strong><ul class="mb-0">';
    changes.payments.added.forEach(p => html += `<li>${p.name}: ${p.from} ‚Üí ${p.to}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.payments.modified.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-exchange-alt text-info me-2"></i>Pagamenti modificati:</strong><ul class="mb-0">';
    changes.payments.modified.forEach(p => html += `<li>${p.name}: ${p.from} ‚Üí ${p.to}</li>`);
    html += '</ul></div>';
  }
  
  if (changes.payments.removed.length > 0) {
    hasChanges = true;
    html += '<div class="mb-2"><strong><i class="fas fa-times-circle text-warning me-2"></i>Pagamenti rimossi:</strong><ul class="mb-0">';
    changes.payments.removed.forEach(p => html += `<li>${p.name}: ${p.from} ‚Üí ${p.to}</li>`);
    html += '</ul></div>';
  }
  
  if (!hasChanges) {
    return '<p class="text-muted"><i class="fas fa-info-circle me-2"></i>Nessuna modifica</p>';
  }
  
  return html;
}

function hasUnsavedChanges() {
  const changes = getChanges();
  if (!changes) return false;
  
  return changes.roster.added.length > 0 ||
         changes.roster.removed.length > 0 ||
         changes.collections.added.length > 0 ||
         changes.collections.modified.length > 0 ||
         changes.collections.archived.length > 0 ||
         changes.collections.unarchived.length > 0 ||
         changes.payments.added.length > 0 ||
         changes.payments.modified.length > 0 ||
         changes.payments.removed.length > 0 ||
         changes.payments.downgrades.length > 0;
}

function cfgLoadToForm(){
  const c = LS.get();
  if (byId('owner')) byId('owner').value = c.owner;
  if (byId('repo'))  byId('repo').value  = c.repo || DEFAULT_REPO;
  if (byId('token')) byId('token').value = c.token;
}

cfgLoadToForm();

byId('saveCfg').addEventListener('click', () => {
  LS.set({ owner: val('owner'), repo: val('repo') || DEFAULT_REPO, token: val('token') });
  updateCfgCollapse();
  showToast('Config salvata' + (SafeStore.ok ? '' : ' (localStorage non disponibile: salvataggio temporaneo)'), 'success');
});

byId('clearCfg').addEventListener('click', async () => {
  if (await confirmAction('Rimuovere la configurazione salvata localmente?')) { 
    LS.clear(); 
    cfgLoadToForm(); 
    updateCfgCollapse();
    showToast('Configurazione rimossa', 'info');
  }
});

async function ghGet(path){ 
  const {owner,repo,token}=LS.get();
  
  // Check if running locally (file:// or localhost)
  if (isLocalEnvironment()) {
    // Try to fetch from local file first
    // Try both with and without 'docs/' prefix
    const pathsToTry = [
      path.replace(/^docs\//, ''),  // Remove 'docs/' prefix first (e.g., 'data/state.json')
      path  // Try as-is second (e.g., 'docs/data/state.json')
    ];
    
    for (const localPath of pathsToTry) {
      try {
        const r = await fetch(localPath);
        if (r.ok) {
          const content = await r.text();
          return {
            sha: 'local-' + Date.now(),
            content: b64encodeUtf8(content)
          };
        }
      } catch (e) {
        // Continue to next path
      }
    }
    
    console.log('Local file not found at:', pathsToTry);
    
    // Fallback to GitHub API only if token is present
    if (!token) {
      throw new Error('File locale non trovato in: ' + pathsToTry.join(' o '));
    }
  }
  
  // Use GitHub API (both for remote and as fallback for local with token)
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const headers = {'Accept':'application/vnd.github+json'};
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const r = await fetch(url,{headers});
  if(!r.ok) throw new Error('GET '+path+' ‚Üí '+r.status);
  return r.json();
}

async function ghPut(path, message, base64Content, sha){
  const {owner,repo,token}=LS.get();
  
  // Check if running locally
  if (isLocalEnvironment() && sha && sha.startsWith('local-')) {
    // Save to local file (download)
    const content = b64decodeUtf8(base64Content);
    const blob = new Blob([content], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = path.split('/').pop();
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showToast('File scaricato! Sostituisci ' + path + ' con il file scaricato e ricarica la pagina.', 'warning');
    
    return {
      content: { sha: 'local-' + Date.now() }
    };
  }
  
  // Use GitHub API for remote saves (requires token)
  if (!token) {
    throw new Error('Token GitHub necessario per salvare su GitHub');
  }
  
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const body={ message, content: base64Content, sha };
  const r=await fetch(url,{method:'PUT', headers:{Authorization:`Bearer ${token}`,'Accept':'application/vnd.github+json'}, body: JSON.stringify(body)});
  if(!r.ok) throw new Error('PUT '+path+' ‚Üí '+r.status);
  return r.json();
}

async function loadState(showToastOnSuccess = true) {
  if (hasUnsavedChanges()) {
    const changes = getChanges();
    const proceed = await confirmActionHTML(
      'Ci sono modifiche non salvate che andranno perse. Vuoi continuare?',
      formatChangesHTML(changes)
    );
    if (!proceed) return;
  }

  try {
    const j = await ghGet('docs/data/state.json');
    SHA = j.sha;
    DB = JSON.parse(b64decodeUtf8(j.content));
    captureOriginalState();
    renderDB();
    byId('stateStatus').textContent = 'Caricato ‚úì';
    byId('stateStatus').className = 'status-badge badge bg-success';
    updateStateCollapse();
    showSavebar();
    if (showToastOnSuccess) {
      showToast('Stato caricato con successo', 'success');
    }
  } catch (e) {
    showToast('Errore nel caricamento: ' + e.message, 'error');
  }
}

byId('load').onclick = () => loadState(true);
byId('stickyLoad').onclick = () => loadState(true);

function renderDB(){
  if (byId('roster')) byId('roster').value = (DB.roster||[]).join('\n');
  const card = byId('collectionsCard');
  const sel  = byId('selColl');
  sel.innerHTML='<option value="__new__">+ Nuova colletta</option>';
  
  // Create a map to preserve original indices
  const sortedWithIndex = (DB.collections||[]).map((c, originalIndex) => ({collection: c, originalIndex}))
    .sort((a,b)=> {
      const ca = a.collection, cb = b.collection;
      return (ca.archived===cb.archived?0:(ca.archived?1:-1)) || (ca.title||ca.id).localeCompare(cb.title||cb.id);
    });
  
  sortedWithIndex.forEach(({collection: c, originalIndex})=>{    
    const opt=document.createElement('option');
    opt.value=originalIndex;  // Use original index, not sorted position
    opt.textContent=(c.title||c.id) + (c.archived ? ' üì¶' : '');
    sel.appendChild(opt);
  });
  
  card.hidden = !DB.collections || DB.collections.length===0;
  sel.onchange = ()=>{ 
    if (sel.value === '__new__') {
      addNewCollection();
      return;
    }
    CURRENT = DB.collections[+sel.value]; 
    fillCollForm(); 
    renderGrid();
    updateSavebarTitle();
  };
  if(DB.collections && DB.collections.length){ 
    sel.value = '0'; 
    CURRENT = DB.collections[0]; 
    fillCollForm(); 
    renderGrid();
    updateSavebarTitle();
  }
}

function fillCollForm(){
  byId('collTitle').value = CURRENT.title||'';
  byId('collId').value    = CURRENT.id||'';
  byId('collDue').value   = (CURRENT.amount_due ?? 0);
  byId('collArchived').checked = !!CURRENT.archived;
}

function readRoster(){
  const rows = (byId('roster')?.value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  DB.roster = Array.from(new Set(rows));
}

function ensureStatuses(){ CURRENT.statuses = CURRENT.statuses || {}; }

function renderGrid(){
  readRoster(); 
  ensureStatuses();
  const grid = byId('grid'); 
  grid.innerHTML='';
  const due = parseFloat(byId('collDue').value||'0') || 0;
  const rosterSorted = DB.roster.slice().sort((a,b)=>a.localeCompare(b));

  rosterSorted.forEach(name=>{
    const id = slug(name);
    const st = CURRENT.statuses[id];

    const rowDiv = document.createElement('div');
    rowDiv.className = 'grid-row fade-in';

    const nameDiv = document.createElement('div');
    nameDiv.className = 'person-name';
    nameDiv.innerHTML = `<i class="fas fa-user-circle text-muted"></i><span>${name}</span>`;

    // --- STATUS SWITCH
    const switchDiv = document.createElement('div');
    switchDiv.className = 'status-switch';

    const r1 = document.createElement('input'); r1.type='radio'; r1.name='r-'+id; r1.id = 'r1-'+id; r1.value = 'unpaid';
    const l1 = document.createElement('label'); l1.textContent='Non pagato'; l1.htmlFor = 'r1-'+id; l1.className = 'status-switch-unpaid';

    const r2 = document.createElement('input'); r2.type='radio'; r2.name='r-'+id; r2.id = 'r2-'+id; r2.value = 'out';
    const l2 = document.createElement('label'); l2.textContent='Non partecipa'; l2.htmlFor = 'r2-'+id; l2.className = 'status-switch-out';

    const r3 = document.createElement('input'); r3.type='radio'; r3.name='r-'+id; r3.id = 'r3-'+id; r3.value = 'paid';
    const l3 = document.createElement('label'); l3.textContent='Ha versato'; l3.htmlFor = 'r3-'+id; l3.className = 'status-switch-paid';

    switchDiv.appendChild(r1); switchDiv.appendChild(l1);
    switchDiv.appendChild(r2); switchDiv.appendChild(l2);
    switchDiv.appendChild(r3); switchDiv.appendChild(l3);

    // --- Helpers di riga
    const applyStatusToModel = (s) => {
      if (!s || s.type === 'unpaid') { delete CURRENT.statuses[id]; return; }
      if (s.type === 'out') { CURRENT.statuses[id] = { type:'out' }; return; }
      CURRENT.statuses[id] = { type:'paid', amount:Number(s.amount||0) };
    };
    const applyStatusToControls = (s) => {
      if (!s || s.type === 'unpaid') {
        r1.checked = true; r2.checked=false; r3.checked=false;
        setPaidLabel(null);
      } else if (s.type === 'out') {
        r1.checked = false; r2.checked=true; r3.checked=false;
        setPaidLabel(null);
      } else {
        r1.checked = false; r2.checked=false; r3.checked=true;
        setPaidLabel(Number(s.amount||0));
      }
    };
    const setPaidLabel = (amountOrNull) => {
      if (amountOrNull == null || isNaN(amountOrNull)) {
        l3.textContent = 'Ha versato';
      } else {
        const euro = amountOrNull.toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2});
        l3.textContent = `Ha versato ${euro}‚Ç¨`;
      }
    };
    const normalizeStatusForDisplay = (st, _due) => {
      if (!st || st.type === 'unpaid') return { type: 'unpaid', amount: 0 };
      if (st.type === 'out') return { type: 'out' };
      const amt = Number(st.amount || 0);
      return { type: 'paid', amount: amt };
    };

    // Stato iniziale UI + "committed"
    const initial = normalizeStatusForDisplay(st, due);
    applyStatusToControls(initial);
    let committed = JSON.parse(JSON.stringify(initial)); // snapshot confermato

    function isDowngrade(prev, next) {
      const wasPaid = prev && prev.type === 'paid';
      if (!wasPaid) return false;
      if (!next || next.type === 'unpaid' || next.type === 'out') return true;
      if (next.type === 'paid') {
        const a = Number(prev.amount || 0), b = Number(next.amount || 0);
        return a !== b;
      }
      return false;
    }

    async function handlePotentialDowngrade(nextCandidate) {
      const prevNorm = normalizeStatusForDisplay(committed, due);
      const nextNorm = normalizeStatusForDisplay(nextCandidate, due);

      if (isDowngrade(prevNorm, nextNorm)) {
        const prevLabel = formatStatus(prevNorm.type, prevNorm.amount);
        const nextLabel = formatStatus(nextNorm.type, nextNorm.amount);
        const choice = await confirmPaymentChange(prevLabel, nextLabel);
        if (choice === 'revert') {
          applyStatusToControls(prevNorm);
          applyStatusToModel(prevNorm);
          showToast('Ripristinato: ' + prevLabel, 'info');
          return false;
        }
        applyStatusToModel(nextNorm);
        committed = JSON.parse(JSON.stringify(nextNorm));
        applyStatusToControls(nextNorm);
        showToast('Modifica confermata: ' + prevLabel + ' ‚Üí ' + nextLabel, 'warning');
        return true;
      } else {
        applyStatusToModel(nextNorm);
        committed = JSON.parse(JSON.stringify(nextNorm));
        applyStatusToControls(nextNorm);
        return true;
      }
    }

    // --- Handlers radio
    r1.onchange = async () => { if (r1.checked) await handlePotentialDowngrade({type:'unpaid', amount:0}); };
    r2.onchange = async () => { if (r2.checked) await handlePotentialDowngrade({type:'out'}); };

    // Apertura dialog su "Ha versato"
    async function openPaidPrompt(prefillFromCurrentSelection) {
      // Valore di default: importo gi√† registrato, altrimenti quota attesa arrotondata
      const defaultAmount = prefillFromCurrentSelection && committed.type==='paid'
        ? Number(committed.amount||0)
        : Math.round(due);

      const valStr = await promptInput('Importo versato (in ‚Ç¨):', String(defaultAmount), 'Inserisci solo il numero, senza simbolo ‚Ç¨');
      if (valStr === null) {
        // Annullato: torna allo stato precedente
        applyStatusToControls(committed);
        return null;
      }
      const v = Number(valStr.replace(',', '.'));
      if (!isFinite(v) || v < 0) {
        showToast('Importo non valido', 'error');
        applyStatusToControls(committed);
        return null;
      }
      return { type: 'paid', amount: v };
    }

    // 1) Primo click: seleziona + prompt
    r3.onchange = async () => {
      if (!r3.checked) return;
      const nextCandidate = await openPaidPrompt(false);
      if (!nextCandidate) return; // annullato
      await handlePotentialDowngrade(nextCandidate);
    };

    // 2) Click sull‚Äôetichetta quando gi√† selezionato ‚Üí edit importo
    l3.addEventListener('click', async (ev) => {
      // Se non √® selezionato, lasciamo che l‚Äôonchange del radio gestisca tutto
      if (!r3.checked) return;
      ev.preventDefault(); // evitiamo il toggle del radio
      const nextCandidate = await openPaidPrompt(true);
      if (!nextCandidate) return; // annullato
      await handlePotentialDowngrade(nextCandidate);
    });

    rowDiv.appendChild(nameDiv);
    rowDiv.appendChild(switchDiv);
    grid.appendChild(rowDiv);
  });
}

async function addNewCollection() {
  DB.collections = DB.collections || [];
  const nid = await promptInput('ID della nuova colletta:', '', 'es: gita-museo-ott-2025');
  if(!nid) {
    // Reset select to current collection
    if (CURRENT) {
      const idx = DB.collections.indexOf(CURRENT);
      byId('selColl').value = idx >= 0 ? idx : '0';
    }
    return;
  }
  const title = await promptInput('Titolo da mostrare:', 
                                   nid.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()),
                                   'es: Gita al museo ‚Äì Ottobre 2025');
  if (!title) {
    if (CURRENT) {
      const idx = DB.collections.indexOf(CURRENT);
      byId('selColl').value = idx >= 0 ? idx : '0';
    }
    return;
  }
  const dueStr = await promptInput('Quota attesa in euro:','10', 'Inserisci solo il numero, senza il simbolo ‚Ç¨');
  const due = parseFloat(dueStr||'0')||0;
  DB.collections.unshift({ id:nid, title, amount_due: due, archived:false, archived_at:null, statuses:{} });
  renderDB();
  showToast('Nuova colletta creata: ' + title, 'success');
}

// byId('allNP').onclick = ()=>{ readRoster(); ensureStatuses(); DB.roster.forEach(n=>{ delete CURRENT.statuses[slug(n)]; }); renderGrid(); };
// byId('allOUT').onclick = ()=>{ readRoster(); ensureStatuses(); DB.roster.forEach(n=>{ CURRENT.statuses[slug(n)]={type:'out'}; }); renderGrid(); };
// byId('allFULL').onclick = ()=>{ 
//   readRoster(); 
//   ensureStatuses(); 
//   const due=parseFloat(byId('collDue').value||'0')||0;
//   DB.roster.forEach(n=>{ CURRENT.statuses[slug(n)]={type:'paid', amount: due}; }); 
//   renderGrid(); 
// };

function syncHeaderToCurrent(){
  CURRENT.title = byId('collTitle').value.trim() || CURRENT.id;
  CURRENT.id    = byId('collId').value.trim()    || CURRENT.id;
  CURRENT.amount_due = parseFloat(byId('collDue').value||'0')||0;
  const wasArchived = !!CURRENT.archived;
  CURRENT.archived  = byId('collArchived').checked;
  if (CURRENT.archived && !wasArchived && !CURRENT.archived_at) {
    CURRENT.archived_at = new Date().toISOString();
  } else if (!CURRENT.archived) {
    CURRENT.archived_at = null;
  }
}

async function saveState() {
  try{
    readRoster();
    if(!Array.isArray(DB.collections) || DB.collections.length===0) throw new Error('Nessuna colletta presente.');
    syncHeaderToCurrent();
    
    // Get and show changes for confirmation
    const changes = getChanges();
    if (!hasUnsavedChanges()) {
      showToast('Nessuna modifica da salvare', 'info');
      return;
    }
    
    const hasDowngrades = changes.payments.downgrades.length > 0;
    const confirmTitle = hasDowngrades 
      ? '‚ö†Ô∏è Attenzione: alcune persone passano da "pagato" a "non pagato"!'
      : 'Conferma salvataggio';
    
    const proceed = await confirmActionHTML(
      confirmTitle,
      '<div class="mb-3"><strong>Stai per salvare le seguenti modifiche:</strong></div>' + formatChangesHTML(changes)
    );
    
    if (!proceed) return;
    
    // Pre-flight check: verify SHA hasn't changed (only for remote/GitHub)
    if (!isLocalEnvironment() || (SHA && !SHA.startsWith('local-'))) {
      try {
        const currentRemote = await ghGet('docs/data/state.json');
        if (currentRemote.sha !== SHA && !SHA.startsWith('local-')) {
          // Conflict detected
          const conflictProceed = await confirmActionHTML(
            '‚ö†Ô∏è Conflitto rilevato!',
            `<div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Il file √® stato modificato da qualcun altro mentre stavi lavorando.</strong>
            </div>
            <p>Per evitare di sovrascrivere le modifiche altrui, devi ricaricare i dati prima di salvare.</p>
            <p><strong>Le tue modifiche correnti andranno perse:</strong></p>
            ${formatChangesHTML(changes)}
            <p class="mt-3"><strong>Vuoi ricaricare ora?</strong> (Le tue modifiche saranno perse)</p>`
          );
          
          if (conflictProceed) {
            await loadState();
          }
          return;
        }
      } catch (e) {
        // If pre-flight check fails, continue anyway (might be offline)
        console.warn('Pre-flight check failed:', e);
      }
    }
    
    DB.updated = new Date().toISOString();
    const content = b64encodeUtf8(JSON.stringify(DB, null, 2));
    const res = await ghPut('docs/data/state.json', 'admin update '+(CURRENT.id||''), content, SHA);
    SHA = res.content.sha;
    captureOriginalState(); // Update baseline after successful save
    showToast('Modifiche salvate con successo!', 'success');
  }catch(e){ 
    if (e.message.includes('409') || e.message.includes('conflict')) {
      showToast('Conflitto: il file √® stato modificato. Ricarica prima di salvare.', 'error');
    } else {
      showToast('Errore nel salvataggio: ' + e.message, 'error');
    }
  }
}

byId('save').onclick = saveState;
byId('stickySave').onclick = saveState;

['collTitle','collId','collDue','collArchived'].forEach(id=> byId(id)?.addEventListener('input', ()=> { syncHeaderToCurrent(); updateSavebarTitle(); }));

function isLocalEnvironment() {
  return window.location.protocol === 'file:' || 
         window.location.hostname === 'localhost' || 
         window.location.hostname === '127.0.0.1';
}

function tokenPresent() {
  const t = (LS.get().token || '').trim();
  return t.length > 0;
}

function canLoadState() {
  // In locale, non serve il token. Su GitHub Pages, serve il token.
  return isLocalEnvironment() || tokenPresent();
}

function updateCfgCollapse() {
  const card = byId('cfgCard');
  const status = byId('cfgStatus');
  const openBtn = byId('cfgOpenBtn');
  if (card) card.classList.remove('collapsed-section');
  
  if (status) {
    if (canLoadState()) {
      if (isLocalEnvironment()) {
        status.textContent = 'Locale (no token) ‚úì';
        status.className = 'status-badge badge bg-info';
      } else {
        status.textContent = 'Token presente ‚úì';
        status.className = 'status-badge badge bg-success';
      }
    } else {
      status.textContent = 'Token necessario';
      status.className = 'status-badge badge bg-warning';
    }
  }
  
  if (openBtn) {
    if (canLoadState()) {
      openBtn.classList.remove('btn-warning');
      if (!openBtn.classList.contains('btn-primary')) {
        openBtn.classList.add('btn-primary');
      }
      openBtn.removeAttribute('title');
    } else {
      openBtn.classList.remove('btn-primary');
      openBtn.classList.add('btn-warning');
      openBtn.setAttribute('title', 'Imposta il token GitHub per abilitare il caricamento da remoto');
    }
  }
}

function updateStateCollapse() {
  const card = byId('stateCard');
  const status = byId('stateStatus');
  const openBtn = byId('stateOpenBtn');
  if (card) card.classList.remove('collapsed-section');
  
  if (status && !DB) {
    if (!canLoadState()) {
      status.textContent = 'Token necessario';
      status.className = 'status-badge badge bg-warning';
    } else {
      status.textContent = 'Non caricato';
      status.className = 'status-badge badge bg-info';
    }
  }
  
  if (openBtn) {
    openBtn.disabled = false;
    if (!canLoadState()) {
      openBtn.classList.remove('btn-outline-primary');
      openBtn.classList.add('btn-outline-warning');
      openBtn.setAttribute('title', 'Configura il token per poter caricare o salvare');
    } else {
      openBtn.classList.remove('btn-outline-warning');
      openBtn.classList.add('btn-outline-primary');
      openBtn.removeAttribute('title');
    }
  }
}

function showSavebar() {
  const bar = byId('savebar');
  if (bar && DB && CURRENT) {
    bar.style.display = 'block';
  }
}

function updateSavebarTitle() {
  const nameSpan = byId('currentCollectionName');
  if (nameSpan && CURRENT) {
    nameSpan.textContent = CURRENT.title || CURRENT.id || 'Colletta';
  }
}

// Toggle handlers removed: sections are now managed via modals.

function autoLoadState() {
  const cfg = LS.get();
  if (!byId('owner').value) byId('owner').value = cfg.owner || DEFAULT_OWNER;
  if (!byId('repo').value)  byId('repo').value  = cfg.repo  || DEFAULT_REPO;

  if (canLoadState()) {
    loadState(false);
  }
}

// Initialize on page load
updateCfgCollapse();
updateStateCollapse();
autoLoadState();

// Warn before leaving if there are unsaved changes
window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges()) {
    e.preventDefault();
    e.returnValue = 'Ci sono modifiche non salvate. Vuoi davvero uscire?';
    return e.returnValue;
  }
});
</script>
</body>
</html>
