<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="robots" content="noindex, nofollow, noimageindex, noarchive">
<meta name="googlebot" content="noindex, nofollow, noimageindex, noarchive">
<link rel="icon" href="./favicon.ico">
<title>Collette â€“ Admin</title>

<!-- Bootstrap + Bootswatch Theme -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/5.3.2/flatly/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
body {
  padding-bottom: 3rem;
}
.sticky-save-bar {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  padding: 0.75rem 0;
  margin-bottom: 1rem;
}
.sticky-save-bar .btn {
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.section-header {
  cursor: pointer;
  user-select: none;
  transition: background-color 0.2s;
  border-radius: 0.375rem;
  padding: 0.5rem;
  margin: -0.5rem;
}
.section-header:hover {
  background-color: rgba(0,0,0,0.03);
}
.section-header i.fa-chevron-down {
  transition: transform 0.3s;
}
.collapsed-section .section-header i.fa-chevron-down {
  transform: rotate(-90deg);
}
.status-badge {
  font-size: 0.8rem;
  padding: 0.25rem 0.6rem;
}
.grid-header {
  display: grid;
  grid-template-columns: 1fr auto auto auto;
  gap: 0.5rem;
  align-items: center;
  padding: 0.75rem;
  background-color: rgba(0,0,0,0.03);
  border-radius: 0.375rem;
  margin-bottom: 0.5rem;
  font-weight: 600;
}
.grid-row {
  display: grid;
  grid-template-columns: 1fr auto auto auto;
  gap: 0.5rem;
  align-items: center;
  padding: 0.75rem;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}
.grid-row:last-child {
  border-bottom: none;
}
.grid-row:hover {
  background-color: rgba(0,0,0,0.02);
}
.person-name {
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.status-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.25rem;
  min-width: 80px;
}
.status-option label {
  font-size: 0.75rem;
  margin: 0;
  text-align: center;
}
.amount-input-group {
  display: flex;
  gap: 0.25rem;
  align-items: center;
  justify-content: flex-end;
}
.amount-input-group input[type="radio"] {
  flex-shrink: 0;
}
.amount-input-group input[type="number"] {
  width: 80px;
  flex-shrink: 0;
}
.amount-input-group .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  flex-shrink: 0;
}
@media (max-width: 768px) {
  .grid-header {
    grid-template-columns: 1fr;
    text-align: center;
  }
  .grid-header > span:not(:first-child) {
    display: none;
  }
  .grid-row {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  .person-name {
    font-size: 1.1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
  }
  .status-option {
    min-width: 100%;
  }
  .amount-input-group {
    justify-content: center;
  }
  .amount-input-group input {
    flex: 1;
  }
}
.fade-in {
  animation: fadeIn 0.3s;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>
<body>

<!-- Sticky Save Bar -->
<div class="sticky-save-bar" id="savebar" style="display:none;">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center">
      <div class="text-white">
        <i class="fas fa-save me-2"></i>
        <span id="currentCollectionName" class="fw-bold">Colletta</span>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-light btn-sm" id="stickyLoad">
          <i class="fas fa-download me-1"></i>Ricarica
        </button>
        <button class="btn btn-success btn-sm" id="stickySave">
          <i class="fas fa-save me-1"></i>Salva modifiche
        </button>
      </div>
    </div>
  </div>
</div>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
      <i class="fas fa-hand-holding-usd text-primary me-2"></i>
      Collette â€“ Admin
    </h1>
  </div>

  <!-- Section 1: Config -->
  <div class="card mb-3 shadow-sm" id="cfgCard">
    <div class="card-body">
      <div class="section-header" id="cfgHeader">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-chevron-down me-2"></i>
            <i class="fas fa-cog text-primary me-2"></i>
            1) Configurazione
          </h5>
          <span class="status-badge badge bg-secondary" id="cfgStatus">Nessun token</span>
        </div>
      </div>
      
      <div id="cfgBody" class="mt-3">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Owner</label>
            <input id="owner" type="text" class="form-control" placeholder="tuo-username">
          </div>
          <div class="col-md-6">
            <label class="form-label">Repo</label>
            <input id="repo" type="text" class="form-control" placeholder="collette-rossi2526" value="collette-rossi2526">
          </div>
        </div>
        <div class="mt-3">
          <label class="form-label">GitHub Fine-grained Token</label>
          <input id="token" type="password" class="form-control" placeholder="ghp_...">
          <small class="form-text text-muted">Il token resta solo in questo browser (localStorage).</small>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button id="saveCfg" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>Salva su questo dispositivo
          </button>
          <button id="clearCfg" class="btn btn-outline-secondary">
            <i class="fas fa-trash me-1"></i>Pulisci config
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 2: State and Roster -->
  <div class="card mb-3 shadow-sm" id="stateCard">
    <div class="card-body">
      <div class="section-header" id="stateHeader">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-chevron-down me-2"></i>
            <i class="fas fa-users text-success me-2"></i>
            2) Stato e Roster
          </h5>
          <span class="status-badge badge bg-info" id="stateStatus">Non caricato</span>
        </div>
      </div>
      
      <div id="stateBody" class="mt-3">
        <div class="d-flex gap-2 mb-3">
          <button id="load" class="btn btn-outline-primary">
            <i class="fas fa-download me-1"></i>Carica stato
          </button>
          <button id="save" class="btn btn-success">
            <i class="fas fa-save me-1"></i>Salva modifiche
          </button>
        </div>
        <div class="alert alert-info mb-3">
          <i class="fas fa-info-circle me-2"></i>
          <small>File: <code>docs/data/state.json</code></small>
        </div>
        <div>
          <label class="form-label">
            <i class="fas fa-list me-1"></i>Roster (un nome per riga â€“ usa "Nome + iniziale cognome")
          </label>
          <textarea id="roster" class="form-control" rows="6"></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Section 3: Collections -->
  <div class="card mb-3 shadow-sm" id="collectionsCard" hidden>
    <div class="card-body">
      <h5 class="mb-3">
        <i class="fas fa-folder-open text-warning me-2"></i>
        3) Collette
      </h5>
      
      <div class="mb-3">
        <label class="form-label">Seleziona colletta</label>
        <select id="selColl" class="form-select">
          <option value="__new__">+ Nuova colletta</option>
        </select>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-5">
          <label class="form-label">Titolo</label>
          <input id="collTitle" type="text" class="form-control">
        </div>
        <div class="col-md-4">
          <label class="form-label">ID</label>
          <input id="collId" type="text" class="form-control" placeholder="es: regalo-natale-2025">
        </div>
        <div class="col-md-2">
          <label class="form-label">Quota attesa (â‚¬)</label>
          <input id="collDue" type="number" step="1" min="0" class="form-control">
        </div>
        <div class="col-md-1">
          <label class="form-label">Archiviata</label>
          <div class="form-check mt-2">
            <input id="collArchived" type="checkbox" class="form-check-input">
            <label class="form-check-label" for="collArchived"></label>
          </div>
        </div>
      </div>
      <small class="text-muted d-block mb-3">ID stabile (niente spazi), usato come chiave.</small>

      <div class="d-flex gap-2 mb-3 flex-wrap">
        <span class="text-muted">Imposta rapidamente:</span>
        <button id="allNP" class="btn btn-sm btn-outline-secondary">
          <i class="fas fa-times-circle me-1"></i>Tutti "non pagato"
        </button>
        <button id="allOUT" class="btn btn-sm btn-outline-warning">
          <i class="fas fa-user-slash me-1"></i>Tutti "non partecipa"
        </button>
        <button id="allFULL" class="btn btn-sm btn-outline-success">
          <i class="fas fa-check-circle me-1"></i>Tutti "quota piena"
        </button>
      </div>

      <hr>

      <div class="grid-header">
        <span><i class="fas fa-user me-1"></i>Nome</span>
        <span class="text-center">Non pagato</span>
        <span class="text-center">Non partecipa</span>
        <span class="text-center">Ha versato</span>
      </div>
      <div id="grid"></div>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
<script>
// --- UTF-8 safe base64 (Unicode-friendly) ---
function b64encodeUtf8(str) {
  if (window.TextEncoder) {
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin);
  }
  return btoa(unescape(encodeURIComponent(str)));
}
function b64decodeUtf8(b64) {
  const bin = atob(b64);
  if (window.TextDecoder) {
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder('utf-8').decode(bytes);
  }
  return decodeURIComponent(escape(bin));
}

const EURO = n => (n ?? 0).toLocaleString('it-IT',{minimumFractionDigits:2,maximumFractionDigits:2})+'â‚¬';
const stripDiacritics = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g, "");
const _supportsUnicodeProps = (() => { try { new RegExp('\\p{L}', 'u'); return true; } catch { return false; } })();
const slug = (s) => {
  const noMarks = stripDiacritics(String(s));
  const re = _supportsUnicodeProps ? /[^\p{Letter}\p{Number}]+/gu : /[^a-z0-9]+/g;
  return noMarks.toLowerCase().replace(re, '-').replace(/(^-|-$)/g, '');
};
const byId = id => document.getElementById(id);

function storageUsable() {
  try {
    const k = '__probe__' + Math.random().toString(36).slice(2);
    localStorage.setItem(k, '1'); localStorage.removeItem(k);
    return true;
  } catch (_) { return false; }
}

const SafeStore = (() => {
  const ok = typeof window !== 'undefined' && 'localStorage' in window && storageUsable();
  const mem = {};
  return {
    ok,
    getItem: k => { try { return ok ? localStorage.getItem(k) : (k in mem ? mem[k] : null); } catch (_) { return k in mem ? mem[k] : null; } },
    setItem: (k, v) => { const s = (v ?? '').toString(); try { ok ? localStorage.setItem(k, s) : (mem[k] = s); } catch (_) { mem[k] = s; } },
    removeItem: k => { try { ok ? localStorage.removeItem(k) : delete mem[k]; } catch (_) { delete mem[k]; } },
  };
})();

const val = id => (byId(id)?.value ?? '').toString();
const DEFAULT_REPO = 'collette-rossi2526';
const DEFAULT_OWNER = 'gsportelli';

const LS = {
  get(){ 
    return {
      owner: SafeStore.getItem('col_owner') || '',
      repo:  SafeStore.getItem('col_repo')  || DEFAULT_REPO,
      token: SafeStore.getItem('col_token') || '',
    };
  },
  set(o = {}){
    if ('owner' in o) SafeStore.setItem('col_owner', (o.owner ?? '').toString().trim());
    if ('repo'  in o) {
      let r = (o.repo ?? DEFAULT_REPO).toString().trim();
      if (!r) r = DEFAULT_REPO;
      SafeStore.setItem('col_repo', r);
    }
    if ('token' in o) SafeStore.setItem('col_token', (o.token ?? '').toString().trim());
  },
  clear(){ ['col_owner','col_repo','col_token'].forEach(k => SafeStore.removeItem(k)); }
};

let SHA = null;
let DB = null;
let CURRENT = null;

function cfgLoadToForm(){
  const c = LS.get();
  if (byId('owner')) byId('owner').value = c.owner;
  if (byId('repo'))  byId('repo').value  = c.repo || DEFAULT_REPO;
  if (byId('token')) byId('token').value = c.token;
}

cfgLoadToForm();

byId('saveCfg').addEventListener('click', () => {
  LS.set({ owner: val('owner'), repo: val('repo') || DEFAULT_REPO, token: val('token') });
  updateCfgCollapse();
  const alertDiv = document.createElement('div');
  alertDiv.className = 'alert alert-success alert-dismissible fade show';
  alertDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Config salvata' + (SafeStore.ok ? '' : ' (localStorage non disponibile: salvataggio temporaneo)') + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
  byId('cfgCard').parentNode.insertBefore(alertDiv, byId('cfgCard'));
  setTimeout(() => alertDiv.remove(), 3000);
});

byId('clearCfg').addEventListener('click', () => {
  if (confirm('Rimuovere config localmente?')) { 
    LS.clear(); 
    cfgLoadToForm(); 
    updateCfgCollapse();
  }
});

async function ghGet(path){ 
  const {owner,repo,token}=LS.get();
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const headers = {'Accept':'application/vnd.github+json'};
  if (token) headers['Authorization'] = `Bearer ${token}`;
  const r = await fetch(url,{headers});
  if(!r.ok) throw new Error('GET '+path+' â†’ '+r.status);
  return r.json();
}

async function ghPut(path, message, base64Content, sha){
  const {owner,repo,token}=LS.get();
  const url=`https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
  const body={ message, content: base64Content, sha };
  const r=await fetch(url,{method:'PUT', headers:{Authorization:`Bearer ${token}`,'Accept':'application/vnd.github+json'}, body: JSON.stringify(body)});
  if(!r.ok) throw new Error('PUT '+path+' â†’ '+r.status);
  return r.json();
}

async function loadState() {
  try{
    const j = await ghGet('docs/data/state.json');
    SHA = j.sha;
    DB = JSON.parse(b64decodeUtf8(j.content));
    renderDB();
    byId('stateStatus').textContent = 'Caricato âœ“';
    byId('stateStatus').className = 'status-badge badge bg-success';
    updateStateCollapse();
    showSavebar();
  }catch(e){ 
    alert('Errore nel caricamento: '+e.message); 
  }
}

byId('load').onclick = loadState;
byId('stickyLoad').onclick = loadState;

function renderDB(){
  if (byId('roster')) byId('roster').value = (DB.roster||[]).join('\n');
  const card = byId('collectionsCard');
  const sel  = byId('selColl');
  sel.innerHTML='<option value="__new__">+ Nuova colletta</option>';
  (DB.collections||[]).slice()
    .sort((a,b)=> (a.archived===b.archived?0:(a.archived?1:-1)) || (a.title||a.id).localeCompare(b.title||b.id))
    .forEach((c,i)=>{    
    const opt=document.createElement('option');
    opt.value=i;
    opt.textContent=(c.title||c.id) + (c.archived ? ' ðŸ“¦' : '');
    sel.appendChild(opt);
  });
  card.hidden = !DB.collections || DB.collections.length===0;
  sel.onchange = ()=>{ 
    if (sel.value === '__new__') {
      addNewCollection();
      return;
    }
    CURRENT = DB.collections[+sel.value]; 
    fillCollForm(); 
    renderGrid();
    updateSavebarTitle();
  };
  if(DB.collections && DB.collections.length){ 
    sel.value = '0'; 
    CURRENT = DB.collections[0]; 
    fillCollForm(); 
    renderGrid();
    updateSavebarTitle();
  }
}

function fillCollForm(){
  byId('collTitle').value = CURRENT.title||'';
  byId('collId').value    = CURRENT.id||'';
  byId('collDue').value   = (CURRENT.amount_due ?? 0);
  byId('collArchived').checked = !!CURRENT.archived;
}

function readRoster(){
  const rows = (byId('roster')?.value || '').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  DB.roster = Array.from(new Set(rows));
}

function ensureStatuses(){ CURRENT.statuses = CURRENT.statuses || {}; }

function renderGrid(){
  readRoster(); 
  ensureStatuses();
  const grid = byId('grid'); 
  grid.innerHTML='';
  const due = parseFloat(byId('collDue').value||'0') || 0;
  const rosterSorted = DB.roster.slice().sort((a,b)=>a.localeCompare(b));

  rosterSorted.forEach(name=>{
    const id = slug(name);
    const st = CURRENT.statuses[id];

    const rowDiv = document.createElement('div');
    rowDiv.className = 'grid-row fade-in';

    const nameDiv = document.createElement('div');
    nameDiv.className = 'person-name';
    nameDiv.innerHTML = `<i class="fas fa-user-circle text-muted"></i><span>${name}</span>`;

    const r1 = document.createElement('input'); 
    r1.type='radio'; 
    r1.name='r-'+id; 
    r1.className='form-check-input';
    const l1 = document.createElement('label'); 
    l1.className='form-check-label'; 
    l1.textContent='Non pagato';
    const opt1 = document.createElement('div');
    opt1.className = 'status-option';
    opt1.appendChild(r1);
    opt1.appendChild(l1);

    const r2 = document.createElement('input'); 
    r2.type='radio'; 
    r2.name='r-'+id; 
    r2.className='form-check-input';
    const l2 = document.createElement('label'); 
    l2.className='form-check-label'; 
    l2.textContent='Non partecipa';
    const opt2 = document.createElement('div');
    opt2.className = 'status-option';
    opt2.appendChild(r2);
    opt2.appendChild(l2);

    const r3 = document.createElement('input'); 
    r3.type='radio'; 
    r3.name='r-'+id; 
    r3.className='form-check-input';
    const amt = document.createElement('input'); 
    amt.type='number'; 
    amt.step='1'; 
    amt.min='0'; 
    amt.className='form-control form-control-sm';
    const btnFull = document.createElement('button'); 
    btnFull.textContent='Tutto'; 
    btnFull.type='button';
    btnFull.className='btn btn-sm btn-outline-success';
    const amtGroup = document.createElement('div');
    amtGroup.className = 'amount-input-group';
    amtGroup.appendChild(r3);
    amtGroup.appendChild(amt);
    amtGroup.appendChild(btnFull);
    const opt3 = document.createElement('div');
    opt3.className = 'status-option';
    opt3.appendChild(amtGroup);

    const setState = (type, amount)=>{ 
      CURRENT.statuses[id] = (type==='none') ? undefined
                           : (type==='out') ? {type:'out'}
                           : {type:(amount>=due? 'paid':'partial'), amount: amount}; 
    };

    if(!st){ r1.checked=true; }
    else if(st.type==='out'){ r2.checked=true; }
    else { r3.checked=true; amt.value = (st.amount ?? 0); }

    r1.onchange = ()=> setState('none');
    r2.onchange = ()=> setState('out');
    r3.onchange = ()=> setState('paid', parseFloat(amt.value||'0')||0);
    amt.oninput = ()=> { r3.checked=true; setState('paid', parseFloat(amt.value||'0')||0); };
    btnFull.onclick = ()=> { amt.value = Math.round(due); r3.checked=true; setState('paid', due); };

    rowDiv.appendChild(nameDiv);
    rowDiv.appendChild(opt1);
    rowDiv.appendChild(opt2);
    rowDiv.appendChild(opt3);
    grid.appendChild(rowDiv);
  });
}

function addNewCollection() {
  DB.collections = DB.collections || [];
  const nid = prompt('ID nuova colletta (es: gita-museo-ott-2025):');
  if(!nid) {
    // Reset select to current collection
    if (CURRENT) {
      const idx = DB.collections.indexOf(CURRENT);
      byId('selColl').value = idx >= 0 ? idx : '0';
    }
    return;
  }
  const title = prompt('Titolo da mostrare (es: Gita al museo â€“ Ottobre 2025):', nid.replace(/-/g,' ').replace(/\b\w/g,m=>m.toUpperCase()));
  const due = parseFloat(prompt('Quota attesa (â‚¬):','10')||'0')||0;
  DB.collections.unshift({ id:nid, title, amount_due: due, archived:false, archived_at:null, statuses:{} });
  renderDB();
}

byId('allNP').onclick = ()=>{ readRoster(); ensureStatuses(); DB.roster.forEach(n=>{ delete CURRENT.statuses[slug(n)]; }); renderGrid(); };
byId('allOUT').onclick = ()=>{ readRoster(); ensureStatuses(); DB.roster.forEach(n=>{ CURRENT.statuses[slug(n)]={type:'out'}; }); renderGrid(); };
byId('allFULL').onclick = ()=>{ 
  readRoster(); 
  ensureStatuses(); 
  const due=parseFloat(byId('collDue').value||'0')||0;
  DB.roster.forEach(n=>{ CURRENT.statuses[slug(n)]={type:'paid', amount: due}; }); 
  renderGrid(); 
};

function syncHeaderToCurrent(){
  CURRENT.title = byId('collTitle').value.trim() || CURRENT.id;
  CURRENT.id    = byId('collId').value.trim()    || CURRENT.id;
  CURRENT.amount_due = parseFloat(byId('collDue').value||'0')||0;
  const wasArchived = !!CURRENT.archived;
  CURRENT.archived  = byId('collArchived').checked;
  if (CURRENT.archived && !wasArchived && !CURRENT.archived_at) {
    CURRENT.archived_at = new Date().toISOString();
  } else if (!CURRENT.archived) {
    CURRENT.archived_at = null;
  }
}

async function saveState() {
  try{
    readRoster();
    if(!Array.isArray(DB.collections) || DB.collections.length===0) throw new Error('Nessuna colletta presente.');
    syncHeaderToCurrent();
    DB.updated = new Date().toISOString();
    const content = b64encodeUtf8(JSON.stringify(DB, null, 2));
    const res = await ghPut('docs/data/state.json', 'admin update '+(CURRENT.id||''), content, SHA);
    SHA = res.content.sha;
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = '<i class="fas fa-check-circle me-2"></i>Salvato con successo âœ“<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
  }catch(e){ 
    alert('Errore nel salvataggio: '+e.message); 
  }
}

byId('save').onclick = saveState;
byId('stickySave').onclick = saveState;

['collTitle','collId','collDue','collArchived'].forEach(id=> byId(id)?.addEventListener('input', ()=> { syncHeaderToCurrent(); updateSavebarTitle(); }));

function tokenPresent() {
  const t = (LS.get().token || '').trim();
  return t.length > 0;
}

function updateCfgCollapse() {
  const card = byId('cfgCard');
  const status = byId('cfgStatus');
  const body = byId('cfgBody');
  if (!card) return;
  
  if (tokenPresent()) {
    card.classList.add('collapsed-section');
    if (body) body.style.display = 'none';
    if (status) {
      status.textContent = 'Token presente âœ“';
      status.className = 'status-badge badge bg-success';
    }
  } else {
    card.classList.remove('collapsed-section');
    if (body) body.style.display = 'block';
    if (status) {
      status.textContent = 'Nessun token';
      status.className = 'status-badge badge bg-secondary';
    }
  }
}

function updateStateCollapse() {
  const card = byId('stateCard');
  const body = byId('stateBody');
  if (!card) return;
  
  if (tokenPresent() && DB) {
    card.classList.add('collapsed-section');
    if (body) body.style.display = 'none';
  } else {
    card.classList.remove('collapsed-section');
    if (body) body.style.display = 'block';
  }
}

function showSavebar() {
  const bar = byId('savebar');
  if (bar && DB && CURRENT) {
    bar.style.display = 'block';
  }
}

function updateSavebarTitle() {
  const nameSpan = byId('currentCollectionName');
  if (nameSpan && CURRENT) {
    nameSpan.textContent = CURRENT.title || CURRENT.id || 'Colletta';
  }
}

// Toggle handlers for collapsible sections
byId('cfgHeader').addEventListener('click', () => {
  const card = byId('cfgCard');
  const body = byId('cfgBody');
  if (card.classList.contains('collapsed-section')) {
    card.classList.remove('collapsed-section');
    body.style.display = 'block';
  } else {
    card.classList.add('collapsed-section');
    body.style.display = 'none';
  }
});

byId('stateHeader').addEventListener('click', () => {
  const card = byId('stateCard');
  const body = byId('stateBody');
  if (card.classList.contains('collapsed-section')) {
    card.classList.remove('collapsed-section');
    body.style.display = 'block';
  } else {
    card.classList.add('collapsed-section');
    body.style.display = 'none';
  }
});

function autoLoadState() {
  const cfg = LS.get();
  if (!byId('owner').value) byId('owner').value = cfg.owner || DEFAULT_OWNER;
  if (!byId('repo').value)  byId('repo').value  = cfg.repo  || DEFAULT_REPO;

  if (tokenPresent() && byId('load')) {
    byId('load').click();
  }
}

// Initialize on page load
updateCfgCollapse();
updateStateCollapse();
autoLoadState();
</script>
</body>
</html>